<!DOCTYPE html>
<html>
<head>
    <title>Book Cover</title>
    <style>
        .config-section {
            margin-bottom: 2em;
            padding: 1.5em;
            background: var(--theme-card-background, #1c1c1e);
            border-radius: 8px;
        }
        .config-section h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--theme-text-secondary, #666);
            padding-bottom: 0.5em;
            margin-bottom: 1em;
        }
        .form-group {
            margin-bottom: 1.5em;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5em;
            font-weight: bold;
        }
        .form-group input[type="number"] {
            width: 120px;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--theme-text-secondary, #666);
            background: var(--theme-background, #101010);
            color: var(--theme-text, #fff);
        }
        .form-group .helper-text {
            font-size: 0.85em;
            color: var(--theme-text-secondary, #999);
            margin-top: 0.3em;
        }
        .status-box {
            padding: 1em;
            border-radius: 6px;
            margin-bottom: 1.5em;
            font-size: 0.95em;
        }
        .status-ok { background: #1b3a1b; border: 1px solid #2d6a2d; }
        .status-err { background: #3a1b1b; border: 1px solid #6a2d2d; }
    </style>
</head>
<body>
    <div id="PdfCoverConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-input,emby-button,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <h2>Book Cover Settings</h2>
                <p style="color: var(--theme-text-secondary, #999); margin-bottom: 1.5em;">
                    Fallback cover provider for books and audiobooks. Extracts PDF first pages via pdftoppm,
                    searches EPUB archives for cover images, and extracts embedded artwork from audio files
                    (MP3, M4A, M4B, FLAC, etc.) via ffmpeg â€” handling mislabeled codec tags that break
                    Jellyfin's built-in Image Extractor.
                </p>

                <div id="statusPdftoppm" class="status-box" style="display:none;"></div>
                <div id="statusFfmpeg" class="status-box" style="display:none;"></div>

                <form id="PdfCoverConfigForm">
                    <div class="config-section">
                        <h3>Rendering</h3>

                        <div class="form-group">
                            <label for="txtDpi">DPI (resolution)</label>
                            <input id="txtDpi" type="number" min="72" max="600" step="1" />
                            <div class="helper-text">
                                Default: 150. Higher = better quality but slower scans and larger images.
                                72 for fast/small, 300 for high quality.
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="txtJpegQuality">JPEG Quality</label>
                            <input id="txtJpegQuality" type="number" min="1" max="100" step="1" />
                            <div class="helper-text">
                                Default: 85. Range 1-100. Lower values produce smaller files.
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="txtTimeout">Timeout (seconds)</label>
                            <input id="txtTimeout" type="number" min="5" max="120" step="1" />
                            <div class="helper-text">
                                Maximum time to wait for pdftoppm to render a single page. Default: 30.
                            </div>
                        </div>
                    </div>

                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var PdfCoverConfig = {
            pluginId: '82eef869-3f18-4678-968d-06efc10b60cf'
        };

        document.querySelector('#PdfCoverConfigPage')
            .addEventListener('pageshow', function () {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(PdfCoverConfig.pluginId).then(function (config) {
                    document.querySelector('#txtDpi').value = config.Dpi || 150;
                    document.querySelector('#txtJpegQuality').value = config.JpegQuality || 85;
                    document.querySelector('#txtTimeout').value = config.TimeoutSeconds || 30;
                    Dashboard.hideLoadingMsg();

                    ApiClient.getJSON(ApiClient.getUrl('PdfCover/Status')).then(function (status) {
                        var pdfBox = document.querySelector('#statusPdftoppm');
                        pdfBox.style.display = 'block';
                        if (status.PdftoppmAvailable) {
                            pdfBox.className = 'status-box status-ok';
                            pdfBox.innerHTML = '&#10003; pdftoppm detected &mdash; PDF cover extraction is active.';
                        } else {
                            pdfBox.className = 'status-box status-err';
                            pdfBox.innerHTML = '&#10007; pdftoppm not found. Install <code>poppler-utils</code> for PDF cover extraction.';
                        }

                        var ffBox = document.querySelector('#statusFfmpeg');
                        ffBox.style.display = 'block';
                        if (status.FfmpegAvailable) {
                            ffBox.className = 'status-box status-ok';
                            ffBox.innerHTML = '&#10003; ffmpeg detected &mdash; Audio cover extraction is active.';
                        } else {
                            ffBox.className = 'status-box status-err';
                            ffBox.innerHTML = '&#10007; ffmpeg not found. Audio cover extraction disabled.';
                        }
                    }).catch(function () {
                        // Endpoint might not exist yet, ignore
                    });
                });
            });

        document.querySelector('#PdfCoverConfigForm')
            .addEventListener('submit', function (e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(PdfCoverConfig.pluginId).then(function (config) {
                    config.Dpi = parseInt(document.querySelector('#txtDpi').value, 10) || 150;
                    config.JpegQuality = parseInt(document.querySelector('#txtJpegQuality').value, 10) || 85;
                    config.TimeoutSeconds = parseInt(document.querySelector('#txtTimeout').value, 10) || 30;
                    ApiClient.updatePluginConfiguration(PdfCoverConfig.pluginId, config).then(function () {
                        Dashboard.processPluginConfigurationUpdateResult();
                    });
                });
            });
    </script>
</body>
</html>
